<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Moving a piece and changing turns | Gamelogic Abstract Strategy </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Moving a piece and changing turns | Gamelogic Abstract Strategy ">
      
      
      <link rel="icon" href="../images/gamelogic_favicon.png">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://bitbucket.org/gamelogic/abstractstrategyunity/src/master/Documentation/content/moving-a-piece-and-changing-turns.md#lines-1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

      <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-68729P67EH"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-68729P67EH');
      </script>
  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../images/gamelogic_icon.png" alt="Gamelogic Abstract Strategy">
            Gamelogic Abstract Strategy
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="moving-a-piece-and-changing-turns">Moving a piece and changing turns</h1>

<p><img src="../images/Moving_Piece.jpg" alt="A checkerboard with one piece from both teams at each end"></p>
<p>Set up a game board with pieces as explained <a href="setting-up-a-grid-and-board.html">here</a>.</p>
<h2 id="1-add-a-rules-script">1. Add a rules script</h2>
<p>Now, create a new script that will handle the logic for moving pieces and swapping turns. In our
example:</p>
<ul>
<li>Each player will have one move.</li>
<li>A player can move their piece to any open space on the board. (This is already configured by the <code>Any Open  Space</code> on the logical piece prefabs.)</li>
<li>In each turn, the player selects the piece to move, and then selects the square to move the piece to.</li>
</ul>
<p>Here is how the script looks:</p>
<pre><code class="lang-csharp" name="GameRules">using UnityEngine;
using Gamelogic.AbstractStrategy.Grids;
using Gamelogic.Extensions;
using Gamelogic.Grids2;

namespace Gamelogic.AbstractStrategy.Samples
{
    public class MovePieceAndSwapTurns : GLMonoBehaviour
    {
        private GridGameManager manager;
        private Player&lt;GridPoint2, GridGamePieceSettings&gt; redPlayer, bluePlayer;
        private IPieceProperties selectedPiece;

        public void Start()
        {
            InitializeGameManager();
            InitializePlayers();

            manager.StartGame();
        }

        public void Update()
        {
            if (Input.GetKeyDown(KeyCode.Space))
            {			
                manager.StartGame(); //Reset Game
            }
        }

        public void OnClick(GridPoint2 point)
        {
            var currentPlayer = manager.CurrentPlayer;

            if (!(currentPlayer is GridHumanPlayer) || !manager.MoveManager.Done)
            {
                return;
            }
            
            // If a block is occupied, try to select
            var state = manager.State;
            var piece = state.TestPosition(point);

            if (piece != null)
            {
                if (piece.PlayerID == currentPlayer.PlayerID)
                {
                    SelectPiece(piece);
                }
            }
            else if (selectedPiece != null)
            {
                // Try to commit move
                var selectedPos = state.FindPiece(selectedPiece);
                var move = state.CreateMovePieceMove(selectedPiece, selectedPos, point);

                if (manager.CommitMove(move))
                {
                    DeselectPiece();
                }
            }
        }

        private void InitializeGameManager()
        {
            manager = GetComponent&lt;GridGameManager&gt;();

            if (manager == null)
            {
                GLDebug.LogError(&quot;You must have a GridGameManager attached to the same gameManager object as this component&quot;);
            }
        }

        private void InitializePlayers()
        {
            redPlayer = new GridHumanPlayer(&quot;red&quot;);
            bluePlayer = new GridHumanPlayer(&quot;blue&quot;);

            manager.RegisterPlayer(redPlayer);
            manager.RegisterPlayer(bluePlayer);
        }

        private void DeselectPiece()
        {
            if (selectedPiece != null)
            {
                UpdateVisualSelectionState(false);
            }

            selectedPiece = null;
        }

        private void SelectPiece(IPieceProperties piece)
        {
            if (selectedPiece != null)
            {
                DeselectPiece();
            }

            selectedPiece = piece;

            UpdateVisualSelectionState(true);
        }

        private void UpdateVisualSelectionState(bool selectionOn)
        {
            var visualPiece = manager.GetExistingVisualPiece(selectedPiece);
            var sprite = visualPiece.GetComponentInChildren&lt;SpriteRenderer&gt;();

            if (sprite != null)
            {
                var colour = sprite.color;
                colour.a = selectionOn ? 0.8f : 1.0f;
                sprite.color = colour;
            }
        }
    }
}
</code></pre>
<p>The script needs to get a reference to the Grid Game Manager, and register the players and handle mouse
input.
The setup used for this example is typical of these types of games. We keep track of the currently selected piece. When
the grid is clicked:</p>
<ul>
<li>If the currently selected piece is <code>null</code>, and the click is over a piece of the player whose turn it is, we make that
piece the selected piece.</li>
<li>If it is not <code>null</code>, and we click on an empty square, the piece is moved there (and the turn ends automatically).</li>
<li>If it is not <code>null</code>, and we click on a piece of the player whose turn it is, that piece becomes the new currently
selected piece.</li>
</ul>
<h2 id="2-add-a-spritecellgrideventtrigger-to-the-grid">2. Add a <code>SpriteCellGridEventTrigger</code> to the grid</h2>
<ul>
<li>Add <code>SpriteCellGridEventTrigger</code> to the grid object. This allows the system to process mouse clicks.</li>
<li>Link the game camera.</li>
<li>Add an event for OnMouseButton down, and link in the grid object to the event, and select the <code>OnClick</code> method of
your game rules script. (This is <code>MovePieceAndSwapTurns.OnClick</code> in our example.)</li>
</ul>

</article>


        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
